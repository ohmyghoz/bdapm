@using DevExtreme.AspNet.Mvc
@{
    Layout = "~/Views/Shared/_LayoutMainMetronic.cshtml";
    string reportId = "Validasi_Data_Transaksi";
    var p = (string[])ViewBag.period;
    var maxItems = db.GetSetting("LimitFilterLJK");
}

@inject BDA.DataModel.DataEntities db

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div class="card card-default">
        <div class="row filter-panel" style="padding-top:0px;">
            <div class="card-body">
                <h1>Validasi Data Transaksi</h1>
                <div class="row">
                    <div class="col-lg-3 form-group">
                        <label>Jenis Periode<span class="mandatory">*</span></label>
                        @(Html.DevExtreme().SelectBox()
                            .ID("Periodid")
                            .DataSource(new[] { "Daily", "Monthly", "Custom Date" })
                            .Width("100%")
                            .OnValueChanged("onPeriodChanged"))
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-3 form-group" id="datepickday">
                        <label>Periode</label>
                        @(Html.DevExtreme().DateBox()
                            .ID("DatepickdID")
                            .Type(DateBoxType.Date)
                            .DisplayFormat("dd/MM/yyyy")
                            .Width("100%"))
                    </div>
                    <div class="col-lg-3 form-group" id="datepickmonth">
                        <label>Periode</label>
                        @(Html.DevExtreme().DateBox()
                            .ID("datePickM")
                            .Type(DateBoxType.Date)
                            .DisplayFormat("monthAndYear")
                            .CalendarOptions(c => c
                            .MaxZoomLevel(CalendarZoomLevel.Year)
                            .MinZoomLevel(CalendarZoomLevel.Century))
                            .Width("100%"))
                    </div>
                    <div class="col-lg-3 form-group" id="starttime">
                        <label>Start Time</label>
                        @(Html.DevExtreme().SelectBox()
                            .ID("StartTime")
                            .DataSource(Enumerable.Range(9, 9).Select(h => new { Value = h.ToString("D2") + ":00", Text = h.ToString("D2") + ":00" }))
                            .ValueExpr("Value")
                            .DisplayExpr("Text")
                            .SearchEnabled(true)
                            .Width("100%"))
                    </div>
                    <div class="col-lg-3 form-group" id="endtime">
                        <label>End Time</label>
                        @(Html.DevExtreme().SelectBox()
                            .ID("EndTime")
                            .DataSource(Enumerable.Range(9, 9).Select(h => new { Value = h.ToString("D2") + ":00", Text = h.ToString("D2") + ":00" }))
                            .ValueExpr("Value")
                            .DisplayExpr("Text")
                            .SearchEnabled(true)
                            .Width("100%"))
                    </div>
                    <div class="col-lg-3 form-group" id="startdate">
                        <label>Start Date</label>
                        @(Html.DevExtreme().DateBox()
                            .ID("StartDateID")
                            .Type(DateBoxType.Date)
                            .DisplayFormat("dd/MM/yyyy")
                            .Width("100%"))
                    </div>
                    <div class="col-lg-3 form-group" id="enddate">
                        <label>End Date</label>
                        @(Html.DevExtreme().DateBox()
                            .ID("EndDateID")
                            .Type(DateBoxType.Date)
                            .DisplayFormat("dd/MM/yyyy")
                            .Width("100%"))
                    </div>

                    <div class="col-lg-3 form-group">
                        <label>Confirmation</label>
                        @(Html.DevExtreme().TagBox()
                            .ID("Confirmationid")
                            .DataSource(new[] {
                    new { Value = "B", Text = "Buy" },
                    new { Value = "S", Text = "Sell" }
                    })
                            .ValueExpr("Value")
                            .DisplayExpr("Text")
                            .ShowSelectionControls(true)
                            .MaxDisplayedTags(3)
                            .SearchEnabled(true)
                            .OnSelectionChanged("onSelectionChanged")
                            .Width("100%"))
                    </div>
                    <div class="col-lg-3 form-group">
                        <label>Lokal/Asing</label>
                        @(Html.DevExtreme().TagBox()
                            .ID("LokalAsingid")
                            .DataSource(new[] {
                    new { Value = "L", Text = "Lokal" },
                    new { Value = "A", Text = "Asing" }
                    })
                            .ValueExpr("Value")
                            .DisplayExpr("Text")
                            .ShowSelectionControls(true)
                            .MaxDisplayedTags(3)
                            .SearchEnabled(true)
                            .OnSelectionChanged("onSelectionChanged")
                            .Width("100%"))
                    </div>
                    <div class="col-lg-3 form-group">
                        <label>Domestik/Foreign</label>
                        @(Html.DevExtreme().TagBox()
                            .ID("DomestikForeignid")
                            .DataSource(new[] { "Domestik", "Foreign" })
                            .ShowSelectionControls(true)
                            .MaxDisplayedTags(3)
                            .SearchEnabled(true)
                            .OnSelectionChanged("onSelectionChanged")
                            .Width("100%"))
                    </div>
                    <div class="col-lg-3 form-group" id="countryInvestorDiv">
                        <label>Country Investor</label>
                        @(Html.DevExtreme().TagBox()
                            .ID("CountryInvestorid")
                            .DataSource(new[] {
                    "Indonesia","Philippines","Singapore","Japan","Other",
                    "Hong Kong","British Virgin Islands","Malaysia","Australia"
                    })
                            .ValueExpr("this")
                            .DisplayExpr("this")
                            .ShowSelectionControls(true)
                            .MaxDisplayedTags(3)
                            .SearchEnabled(true)
                            .OnSelectionChanged("onSelectionChanged")
                            .Width("100%"))
                    </div>
                    <div class="col-lg-3 form-group">
                        <label>Type Investor</label>
                        @(Html.DevExtreme().TagBox()
                        .ID("TypeInvestorid")
                        .DataSource(new[] { "IB", "OT", "PF", "ID", "SC", "FD", "CP", "IS" })
                        .ValueExpr("this")
                        .DisplayExpr("this")
                        .ShowSelectionControls(true)
                        .MaxDisplayedTags(3)
                        .SearchEnabled(true)
                        .OnSelectionChanged("onSelectionChanged")
                        .Width("100%"))
                    </div>

                    <div class="col-lg-3 form-group">
                        <label>AB Code</label>
                        @(Html.DevExtreme().TagBox()
                            .ID("ABcodeid")
                            .DataSource(new[] {
                    "NI","MK","IU","DR","PD","MI","SS","MU","IF","AI","OK","II",
                    "EP","BQ","PS","KI","YU","SQ","RS","BF","LG","GA","LS","IN",
                    "BZ","IH","FS","XA","GR","EL","AT","CC","PC","AR","PK","FZ",
                    "RB","BS","OD","DH","YP","ID","TP","TX","YB","HP","AO","RO",
                    "ES","RG","IP","XC","CP","ZR","SH","HD","PO","CD","AN","YJ",
                    "DP","MG","IT","SA","AG","AD","DX","KS","TF","PG","KK","ZP",
                    "LH","AP","AZ","RF"
                    })
                            .ValueExpr("this")
                            .DisplayExpr("this")
                            .ShowSelectionControls(true)
                            .MaxDisplayedTags(3)
                            .SearchEnabled(true)
                            .OnSelectionChanged("onSelectionChanged")
                            .Width("100%"))

                    </div>
                    <div class="col-lg-3 form-group">
                        <label>Market</label>
                        @(Html.DevExtreme().TagBox()
                            .ID("Marketid")
                            .DataSource(new[] { "TN", "NG", "RG" })
                            .ValueExpr("this")
                            .DisplayExpr("this")
                            .ShowSelectionControls(true)
                            .MaxDisplayedTags(3)
                            .SearchEnabled(true)
                            .OnSelectionChanged("onSelectionChanged")
                            .Width("100%"))
                    </div>

                    <div class="col-lg-3 form-group" id="topDiv">
                        <label>Top</label>
                        @(Html.DevExtreme().SelectBox()
                            .ID("itemsPerPage")
                            .DataSource(new[] {
                    new { Value = 10, Text = "10" },
                    new { Value = 25, Text = "25" },
                    new { Value = 50, Text = "50" },
                    new { Value = 100, Text = "100" },
                    new { Value = 150, Text = "150" },
                    new { Value = 200, Text = "200" },
                    new { Value = 0, Text = "All" }
                    })
                            .ValueExpr("Value")
                            .DisplayExpr("Text")
                            .Value(10)
                            .Width("100%"))
                    </div>
                </div>

                <div class="float-left">
                    @(Html.DevExtreme().Button()
                        .ID("Filter")
                        .Type(ButtonType.Default)
                        .Text("Tampilkan")
                        .OnClick("onButtonFilterClicked")
                        .ValidationGroup("Filter"))
                </div>
            </div>
        </div>
    </div>

    <div class="card-body">
        @(Html.DevExtreme().PivotGrid()
            .ID("pivotgrid")
            .ShowRowGrandTotals(false)
            .ShowRowTotals(false)
            .AllowSortingBySummary(true)
            .AllowSorting(true)
            .AllowFiltering(true)
            .Scrolling(s => s.Mode(PivotGridScrollingMode.Virtual))
            .Height(800)
            .ShowBorders(true)
            .FieldPanel(p => p
            .ShowRowFields(true)
            .ShowFilterFields(false)
            .AllowFieldDragging(false)
            .Visible(true)
            )
            .DataSource(d => d
            .Store(s => s.Mvc()
            .Controller("MarketDriven")
            .LoadAction("GetMarketData")
            .Area("BDAPM")

            // IMPORTANT: Force GET so it hits the [HttpGet] action
            .LoadMethod("GET")

            // IMPORTANT: Attach all filter params into the request
            .OnBeforeSend("dxBeforeSendAddFilters")
            )
            .Fields(f =>
            {
                f.Add().Caption("Transaction Date").DataField("TransactionDates").Expanded(true).Width(200).Area(PivotGridArea.Row);
                f.Add().Caption("SID").DataField("sid_ori").Expanded(true).Width(200).Area(PivotGridArea.Row);
                f.Add().Caption("SID Name").DataField("cpinvestorcode").Width(200).Expanded(true).Area(PivotGridArea.Row);
                f.Add().Caption("Investor Code").DataField("investorcode").Width(200).Expanded(true).Area(PivotGridArea.Row);
                f.Add().Caption("Security Code").DataField("securitycode").Width(200).Expanded(true).Area(PivotGridArea.Row);
                f.Add().Caption("Quantity").DataField("quantity").Width(50).SummaryType(SummaryType.Sum).Format("#,##0").Area(PivotGridArea.Data);
                f.Add().Caption("Value").DataField("value").Width(50).SummaryType(SummaryType.Sum).Format("#,##0").Area(PivotGridArea.Data);
            })
            )
            )
    </div>

    <!-- The Modal  Detail-->
    <div class="modal fade" id="ModalSimpanPenggunaanData" tabindex="-1" role="document" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background-color:#0066b2">
                    <h4 class="modal-title" style="text-align:left">
                        <font color="white">Pilih Penggunaan Data</font>
                    </h4>
                </div>
                <div class="modal-body">
                    <form id="StrukturFormDetail" method="POST" action="" class="form-horizontal row-border">
                        <div class="row" style="padding: 0 10px 0 10px;">
                            @(Html.DevExtreme().SelectBox()
                                .ID("penggunaandataid")
                                .DataSource(d => d.Mvc()
                                .Controller("PenggunaanData")
                                .Area("Website")
                                .LoadAction("GetPenggunaanData")
                                .Key("value"))
                                .ValueExpr("value")
                                .DisplayExpr("text")
                                .SearchEnabled(true)
                                .Width("100%")
                                )
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" id="btnSavePenggunaanData" class="btn btn-primary" data-bs-dismiss="modal"><i class='fa fa-save'></i> Save</button>
                </div>
            </div>
        </div>
    </div>
}

<script>
    // DevExtreme PDF utils already present in your file
    window.jsPDF = window.jspdf.jsPDF;
    applyPlugin(window.jsPDF);

    function pad2(n) { return ('0' + n).slice(-2); }
    function formatDateToYYYYMMDD(dateObj) {
        if (!dateObj) return null;
        return '' + dateObj.getFullYear() + pad2(dateObj.getMonth() + 1) + pad2(dateObj.getDate());
    }
    function formatMonthToYYYYMM(dateObj) {
        if (!dateObj) return null;
        return '' + dateObj.getFullYear() + pad2(dateObj.getMonth() + 1);
    }

    function getFilterParams() {
        var periodType = $("#Periodid").dxSelectBox("instance")?.option("value") || null;

        var dailyDate = $("#DatepickdID").dxDateBox("instance")?.option("value") || null;
        var monthlyDate = $("#datePickM").dxDateBox("instance")?.option("value") || null;
        var startDate = $("#StartDateID").dxDateBox("instance")?.option("value") || null;
        var endDate = $("#EndDateID").dxDateBox("instance")?.option("value") || null;

        var params = {
            periodType: periodType,
            selectedDate: dailyDate ? formatDateToYYYYMMDD(dailyDate) : null,
            selectedMonth: monthlyDate ? formatMonthToYYYYMM(monthlyDate) : null,
            startDate: startDate ? formatDateToYYYYMMDD(startDate) : null,
            endDate: endDate ? formatDateToYYYYMMDD(endDate) : null,
            startTime: $("#StartTime").dxSelectBox("instance")?.option("value") || null,
            endTime: $("#EndTime").dxSelectBox("instance")?.option("value") || null,
            confirmation: $("#Confirmationid").dxTagBox("instance")?.option("value") || [],
            lokalAsing: $("#LokalAsingid").dxTagBox("instance")?.option("value") || [],
            countryInvestor: $("#CountryInvestorid").dxTagBox("instance")?.option("value") || [],
            typeInvestor: $("#TypeInvestorid").dxTagBox("instance")?.option("value") || [],
            market: $("#Marketid").dxTagBox("instance")?.option("value") || [],
            abCodes: $("#ABcodeid").dxTagBox("instance")?.option("value") || [],
            topN: $("#itemsPerPage").dxSelectBox("instance")?.option("value") ?? 10,
            _ts: Date.now() // prevent caching
        };

        console.log("[getFilterParams] Built params:", params);
        return params;
    }

    // IMPORTANT: attach params on every load + prevent caching + proper array serialization
    function dxBeforeSendAddFilters(method, ajaxOptions) {
        var p = getFilterParams();

        // Make jQuery serialize arrays as key=val1&key=val2 (no [] suffix)
        ajaxOptions.traditional = true;
        ajaxOptions.cache = false;

        // Merge our params into outgoing request
        ajaxOptions.data = ajaxOptions.data || {};
        Object.assign(ajaxOptions.data, p);

        // Ensure GET to match controller signature
        ajaxOptions.method = "GET";

        console.log("[dxBeforeSendAddFilters] method:", method, " url:", ajaxOptions.url, " data:", ajaxOptions.data);
    }

    // 1) Refresh parameters every click: reload the pivot grid data source so OnBeforeSend runs and sends current params
    function onButtonFilterClicked() {
        var pivotGridInstance = $("#pivotgrid").data("dxPivotGrid");
        if (pivotGridInstance) {
            console.log("[onButtonFilterClicked] Reloading pivot with params:", getFilterParams());
            // Force a new load so OnBeforeSend picks up latest values
            pivotGridInstance.getDataSource().reload();
        }
    }


    function onPeriodChanged(e) {
        const selectedValue = e.value;
        const datepickdayDiv = document.getElementById("datepickday");
        const datepickmonthDiv = document.getElementById("datepickmonth");
        const starttimeDiv = document.getElementById("starttime");
        const endtimeDiv = document.getElementById("endtime");
        const startdateDiv = document.getElementById("startdate");
        const enddateDiv = document.getElementById("enddate");

        if (selectedValue === "Daily") {
            starttimeDiv.style.display = "block";
            endtimeDiv.style.display = "block";
            datepickdayDiv.style.display = "block";
            datepickmonthDiv.style.display = "none";
            startdateDiv.style.display = "none";
            enddateDiv.style.display = "none";
        } else if (selectedValue === "Monthly") {
            datepickmonthDiv.style.display = "block";
            starttimeDiv.style.display = "none";
            endtimeDiv.style.display = "none";
            datepickdayDiv.style.display = "none";
            startdateDiv.style.display = "none";
            enddateDiv.style.display = "none";
        } else {
            starttimeDiv.style.display = "none";
            endtimeDiv.style.display = "none";
            datepickdayDiv.style.display = "none";
            datepickmonthDiv.style.display = "none";
            startdateDiv.style.display = "block";
            enddateDiv.style.display = "block";
        }
    }

    $(document).ready(function () {
        // Hide sections initially
        document.getElementById("starttime").style.display = "none";
        document.getElementById("endtime").style.display = "none";
        document.getElementById("datepickday").style.display = "none";
        document.getElementById("datepickmonth").style.display = "none";
        document.getElementById("startdate").style.display = "none";
        document.getElementById("enddate").style.display = "none";
    });

    function onSelectionChanged(e) {
        if (e.addedItems.length > 0) {
            e.component.field().val("");
        }
    }

</script>

<style type="text/css">
    .mandatory {
        color: red;
    }
</style>