@using DevExtreme.AspNet.Mvc
@{
    Layout = "~/Views/Shared/_LayoutMainMetronic.cshtml";
    var monthyearawal = (dynamic)null;
    var monthyearakhir = (dynamic)null;
    monthyearawal = ViewBag.monthyearawal;
    monthyearakhir = ViewBag.monthyearakhir;
}
@inject BDA.DataModel.DataEntities db

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()
    <div class="card card-default">

        <div class="row filter-panel" style="padding-top:0px;">
            <div class="card-body">
                <div class="row">

                    <div class="col-lg-3 form-group">
                        <label>Periode Awal<span class="mandatory">*</span></label>
                        @(Html.DevExtreme().DateBox()
                            .ID("PeriodeAwal")
                            .DisplayFormat("dd MMM yyyy")
                            .Value(DateTime.Now)
                            .Max(DateTime.Now)
                            .Width("100%"))
                    </div>

                     <div class="col-lg-3 form-group">
                        <label>Periode Akhir<span class="mandatory">*</span></label>
                        @(Html.DevExtreme().DateBox()
                            .ID("PeriodeAkhir")
                            .DisplayFormat("dd MMM yyyy")
                            .Value(DateTime.Now)
                            .Min(DateTime.Now)
                            .Width("100%"))
                    </div>

                     <div class="col-lg-2 form-group">
                        <label>Case ID</label>
                        @(Html.DevExtreme().TagBox()
                            .ID("caseid")
                            .DataSource(new[] { "P1", "P2", "P3", "P4", "P5", "P6", "P7" })
                            .ShowSelectionControls(true)
                            .MaxDisplayedTags(3)
                            .SearchEnabled(true)
                            .OnSelectionChanged("onSelectionChanged")
                            .Width("100%")
                            .Placeholder("(ALL)"))
                    </div>

                     <div class="col-lg-2 form-group">
                        <label>Trade ID</label>
                        @(Html.DevExtreme().TagBox()
                            .ID("tradeid")
                            .DataSource(d => d.Mvc()
                            .Controller("MMTransaksiSPV")
                            .LoadAction("GetTradeID")
                            .Key("value"))
                            .ValueExpr("value")
                            .DisplayExpr("text")
                            .ShowSelectionControls(true)
                            .MaxDisplayedTags(3)
                            .SearchEnabled(true)
                            .ShowClearButton(true)
                            .Width("100%"))
                    </div>

                     <div class="col-lg-2 form-group">
                        <label>
                            Bond Issuer Type Code
                        </label>
                        @(Html.DevExtreme().TagBox()
                            .ID("bondtypecode")
                            .DataSource(d => d.Mvc()
                            .Controller("MMTransaksiSPV")
                            .LoadAction("GetBondTypeCode")
                            .Key("value"))
                            .ValueExpr("value")
                            .DisplayExpr("text")
                            .ShowSelectionControls(true)
                            .MaxDisplayedTags(3)
                            .SearchEnabled(true)
                            .ShowClearButton(true)
                            .Width("100%"))
                    </div>
                </div>

                <div class="row">

                    <div class="col-lg-2 form-group">
                        <label>
                            Source Name
                        </label>
                        @(Html.DevExtreme().TagBox()
                            .ID("sourcenameid")
                            .DataSource(d => d.Mvc()
                            .Controller("MMTransaksiSPV")
                            .LoadAction("GetSourceNameID")
                            .Key("value"))
                            .ValueExpr("value")
                            .DisplayExpr("text")
                            .ShowSelectionControls(true)
                            .MaxDisplayedTags(3)
                            .SearchEnabled(true)
                            .ShowClearButton(true)
                            .Width("100%"))
                    </div>

                    <div class="col-lg-2 form-group">
                        <label>Target Name</label>
                        @(Html.DevExtreme().TagBox()
                            .ID("targetnameid")
                            .DataSource(d => d.Mvc()
                            .Controller("MMTransaksiSPV")
                            .LoadAction("GetTargetNameID")
                            .Key("value"))
                            .ValueExpr("value")
                            .DisplayExpr("text")
                            .ShowSelectionControls(true)
                            .MaxDisplayedTags(3)
                            .SearchEnabled(true)
                            .ShowClearButton(true)
                            .Width("100%"))
                    </div>

                    <div class="col-lg-2 form-group">
                        <label>Report Type</label>
                        @(Html.DevExtreme().TagBox()
                            .ID("reporttypeid")
                            .DataSource(d => d.Mvc()
                            .Controller("MMTransaksiSPV")
                            .LoadAction("GetReportTypeID")
                            .Key("value"))
                            .ValueExpr("value")
                            .DisplayExpr("text")
                            .ShowSelectionControls(true)
                            .MaxDisplayedTags(3)
                            .SearchEnabled(true)
                            .ShowClearButton(true)
                            .Width("100%"))
                    </div>

                    <div class="col-lg-4 form-group">
                        <label>
                            Bond Late Completeness Status Code
                        </label>
                        @(Html.DevExtreme().TagBox()
                            .ID("bondlateid")
                            .DataSource(d => d.Mvc()
                            .Controller("MMTransaksiSPV")
                            .LoadAction("GetBondLateID")
                            .Key("value"))
                            .ValueExpr("value")
                            .DisplayExpr("text")
                            .ShowSelectionControls(true)
                            .MaxDisplayedTags(3)
                            .SearchEnabled(true)
                            .ShowClearButton(true)
                            .Width("100%"))
                    </div>

                    <div class="col-lg-2 form-group">
                        <label>
                            Bond Report Status
                        </label>
                        @(Html.DevExtreme().TagBox()
                            .ID("bondreportid")
                            .DataSource(d => d.Mvc()
                            .Controller("MMTransaksiSPV")
                            .LoadAction("GetBondReportStatusID")
                            .Key("value"))
                            .ValueExpr("value")
                            .DisplayExpr("text")
                            .ShowSelectionControls(true)
                            .MaxDisplayedTags(3)
                            .SearchEnabled(true)
                            .ShowClearButton(true)
                            .Width("100%"))
                    </div>

                </div>

                <table>
                    <tr>
                        <td>
                            <div class="float-left">
                                @(Html.DevExtreme().Button()
                                    .ID("Filter")
                                    .Type(ButtonType.Default)
                                    .Text("Tampilkan")
                                    .OnClick("onButtonFilterClicked")
                                    .ValidationGroup("Filter"))
                            </div>
                        </td>
                        <td>
                            <div class="float-left">
                                @(Html.DevExtreme().Button()
                                    .ID("Filters")
                                    .Type(ButtonType.Success)
                                    .Text("Cancel")
                                    .OnClick("onButtonFilterClickedCancel"))
                            </div>
                        </td>
                    </tr>
                </table>
                <br />
                <br />
                @*grid*@
                <div class="row filter-panel" style="padding-top:0px;">
                    <div class="card-body">
                        <div class="float-right">
                            @if (ViewBag.Export)
                            {
                                <a class="btn btn-light-primary font-weight-bolder btn-sm mr-2" href="javascript:ExportToExcelIndex();"><span class="image fa fa-file-excel"></span> Export Excel</a>
                                <a class="btn btn-light-primary font-weight-bolder btn-sm mr-2" href="javascript:ExportToPdfIndex();"><span class="image fa fa-file-pdf"></span> Export PDF</a>
                            }
                        </div>
                    </div>
                </div>
                <div class="gridview-div">
                    @(Html.DevExtreme().DataGrid()
                        .ID("grid1")
                        .ShowBorders(true).Width("100%").ShowColumnLines(true).ShowRowLines(true)
                        .DataSource(d => d.Mvc()
                        .Controller("SegmentationSummaryClusterMKBD")
                        .LoadAction("GetGridData")
                        .Key("securitycompanycode")
                        .OnBeforeSend("onGridBeforeSend"))
                        .RemoteOperations(true)
                        .Width("100%")
                        .AllowColumnResizing(true)
                        .ColumnAutoWidth(true)
                        .WordWrapEnabled(true)
                        .Columns(columns =>
                        {
                            columns.Add().DataField("no").Caption("No.").Alignment(HorizontalAlignment.Center);
                            columns.Add().DataField("securitycompanycode").Caption("Kode PE").Alignment(HorizontalAlignment.Center);
                            columns.Add().DataField("securitycompanyname").Caption("Nama PE").Width(300);
                            columns.Add().DataField("simpanangiro").Caption("Simpanan Giro").Alignment(HorizontalAlignment.Right).DataType(GridColumnDataType.Number).Format(",##0");
                            columns.Add().DataField("depositolt3bulan").Caption("Deposito < 3 Bulan").Alignment(HorizontalAlignment.Right).DataType(GridColumnDataType.Number).Format(",##0");
                            columns.Add().DataField("depositogt3bulandijaminlps").Caption("Deposito > 3 Bulan Dijamin LPS").Alignment(HorizontalAlignment.Right).DataType(GridColumnDataType.Number).Format(",##0");
                            columns.Add().DataField("uangjaminanlkp").Caption("Uang Jaminan LKP").Alignment(HorizontalAlignment.Right).DataType(GridColumnDataType.Number).Format(",##0");
                            columns.Add().DataField("kasdansetarakas").Caption("Kas dan Setara Kas (Simpanan Giro + Deposito < 3 Bulan + Uang Jaminan LKP)").Alignment(HorizontalAlignment.Right).DataType(GridColumnDataType.Number).Format(",##0");
                            columns.Add().DataField("mkbd").Caption("MKBD").Format("#,##0").Alignment(HorizontalAlignment.Right).DataType(GridColumnDataType.Number).Format(",##0");
                            columns.Add().DataField("mkbdminimum").Caption("MKBD Minimum").Alignment(HorizontalAlignment.Right).DataType(GridColumnDataType.Number).Format(",##0");
                            columns.Add().DataField("mkbdpermkbdminimum").Caption("MKBD Terhadap MKBD Minimum %").Alignment(HorizontalAlignment.Right).DataType(GridColumnDataType.Number).Format(",##0");
                            columns.Add().DataField("cluster").Caption("Cluster").Alignment(HorizontalAlignment.Center);
                            columns.Add().DataField("status").Caption("Status");
                            @*  columns.Add().DataField("status").Visible(false); *@
                            columns.Add().Type(GridCommandColumnType.Buttons).Caption("Action").Buttons(b =>
                            {
                                b.Add()
                            .Hint("Detail")
                            .Icon("detailslayout")
                            .OnClick("Detail");
                            });
                        })
                        .FilterRow(f => f.Visible(true))
                        .ShowBorders(true)
                        .Paging(p =>
                        {
                            p.PageSize(20);
                            p.Enabled(true);
                        })
                        .Pager(p =>
                        {
                            p.ShowInfo(true);
                        }))
                </div>
            </div>
        </div>

    </div>
}

<script>
    window.jsPDF = window.jspdf.jsPDF;
    applyPlugin(window.jsPDF);
</script>

<style type="text/css">
    .mandatory {
        color: red;
    }
</style>
<script>

    $(function () {
           const startDate = $("#PeriodeAwal").dxDateBox({
               onValueChanged: function (e) {
                   endDate.option("min", e.value);
               }
           }).dxDateBox("instance");
           const endDate = $("#PeriodeAkhir").dxDateBox({
               onValueChanged: function (e) {
                   startDate.option("max", e.value);
               }
           }).dxDateBox("instance");

           $("#PeriodeAwal").dxValidator({
               validationGroup: "Filter",
               validationRules: [{ type: "required", message: "[Periode Awal] harus dipilih" }]
           })
           $("#PeriodeAkhir").dxValidator({
               validationGroup: "Filter",
               validationRules: [{ type: "required", message: "[Periode Akhir] harus dipilih" }]
           })
    });

    function onSelectionChanged(e) {
        if (e.addedItems.length > 0) {
            e.component.field().val(""); // Clears the search text. However, search filter is only applied to the widget after focus is lost in the input element
        }
    }

        function onButtonFilterClicked(e) {
        let tempPeriodeAwal = $("#PeriodeAwal").dxDateBox("instance").option("value");
        let tempPeriodeAkhir = $("#PeriodeAkhir").dxDateBox("instance").option("value");
        let amandedtypeinfo = $("#Amandedid").dxTagBox("instance").option("value");


        let periodeAwal = null;
        if (tempPeriodeAwal != null) {
            periodeAwal = tempPeriodeAwal.getFullYear() + '-' + String(tempPeriodeAwal.getMonth() + 1).padStart(2, '0') + '-' + String(tempPeriodeAwal.getDate()).padStart(2, '0');
        }

        let periodeAkhir = null;
        if (tempPeriodeAkhir != null) {
            periodeAkhir = tempPeriodeAkhir.getFullYear() + '-' + String(tempPeriodeAkhir.getMonth() + 1).padStart(2, '0') + '-' + String(tempPeriodeAkhir.getDate()).padStart(2, '0');
        }

        //$("#grid1").dxDataGrid("instance").refresh();

        $.ajax({
            url: '@Url.Action("GetChartTypeInfo", "MMKoreksiTransaksi")',
            data: { periodeAwal: periodeAwal, periodeAkhir: periodeAkhir, amandedtypeinfo: JSON.stringify(amandedtypeinfo) },
            dataType: "json",
            type: "POST",
            success: function (response) {
            $("#pie-chartTypeOfInfo").dxPieChart("instance").refresh();
            }
        });

        $.ajax({
            url: '@Url.Action("GetChartTypeFirmID", "MMKoreksiTransaksi")',
            data: { periodeAwal: periodeAwal, periodeAkhir: periodeAkhir, amandedtypeinfo: JSON.stringify(amandedtypeinfo) },
            dataType: "json",
            type: "POST",
            success: function (response) {
            $("#pie-chartTypeOfFirmID").dxPieChart("instance").refresh();
            }
        });

        $.ajax({
            url: '@Url.Action("GetBarChartAmendMarket", "MMKoreksiTransaksi")',
            data: { periodeAwal: periodeAwal, periodeAkhir: periodeAkhir, amandedtypeinfo: JSON.stringify(amandedtypeinfo) },
            dataType: "json",
            type: "POST",
            success: function (response) {
            $("#bar-chartJumlahMarket").dxChart("instance").refresh();
            }
        });

         $.ajax({
            url: '@Url.Action("GetBarChartNonAmendMarket", "MMKoreksiTransaksi")',
            data: { periodeAwal: periodeAwal, periodeAkhir: periodeAkhir, amandedtypeinfo: JSON.stringify(amandedtypeinfo) },
            dataType: "json",
            type: "POST",
            success: function (response) {
            $("#bar-chartJumlahNonMarket").dxChart("instance").refresh();
            }
        });

        $.ajax({
            url: '@Url.Action("GetBarChartTop10AmendMarket", "MMKoreksiTransaksi")',
            data: { periodeAwal: periodeAwal, periodeAkhir: periodeAkhir, amandedtypeinfo: JSON.stringify(amandedtypeinfo) },
            dataType: "json",
            type: "POST",
            success: function (response) {
            $("#bar-chartJumlahTop10Market").dxChart("instance").refresh();
            }
        });
    }

    function onButtonFilterClickedCancel(e) {
        location.reload(); // Reloads the page, possibly from cache
    }

    function onGridBeforeSend(method, ajaxOptions) {
        let tempPeriodeAwal = $("#PeriodeAwal").dxDateBox("instance").option("value");
        let tempPeriodeAkhir = $("#PeriodeAkhir").dxDateBox("instance").option("value");
        let namaPE = $("#namaPEid").dxSelectBox("instance").option("value");
        let status = $("#Statusid").dxTagBox("instance").option("value");


       let periodeAwal = null;
        if (tempPeriodeAwal != null) {
            periodeAwal = tempPeriodeAwal.getFullYear() + '-' + String(tempPeriodeAwal.getMonth() + 1).padStart(2, '0') + '-' + String(tempPeriodeAwal.getDate()).padStart(2, '0');
        }

        let periodeAkhir = null;
        if (tempPeriodeAkhir != null) {
            periodeAkhir = tempPeriodeAkhir.getFullYear() + '-' + String(tempPeriodeAkhir.getMonth() + 1).padStart(2, '0') + '-' + String(tempPeriodeAkhir.getDate()).padStart(2, '0');
        }

         ajaxOptions.data.periodeAwal = periodeAwal;
        ajaxOptions.data.periodeAkhir = periodeAkhir;
        ajaxOptions.data.namaPE = namaPE;
        ajaxOptions.data.status = JSON.stringify(status);
    }
</script>